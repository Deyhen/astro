---
import PhoneInput from '../PhoneInput/PhoneInput.astro';
import './contacts.css';
---

<section id="contacts" class="contacts-section">
  <div class="contacts-bg"></div>
  <div class="contacts-overlay"></div>

  <div class="contacts-inner" data-aos="fade-up">
    <h2 class="contacts-title">Оставьте заявку</h2>

    <p class="contacts-subtitle">
      Расскажите, какой автомобиль вы ищете — мы подберём лучшие варианты и рассчитаем стоимость с
      доставкой и оформлением.
    </p>

    <form class="contacts-form" id="contacts-form">
      <div class="input-wrapper">
        <input type="text" name="name" class="contacts-input" placeholder="Имя" />
      </div>

      <div class="input-wrapper">
        <PhoneInput id="contacts-phone" name="phone" />
      </div>

      <button type="submit" class="contacts-button"> Оставить заявку </button>
    </form>

    <p class="contacts-consent">
      Отправляя заявку, вы даете свое согласие на <a href="/policy">обработку персональных данных</a
      >.
    </p>
  </div>
</section>

<script>
  import { initFormValidation } from '../../scripts/formValidation';

  const API_URL =
    import.meta.env.PUBLIC_API_URL || 'https://app-server.arcticautotrade.workers.dev';

  // Wait for phone input to be initialized
  window.addEventListener('load', () => {
    const form = document.getElementById('contacts-form') as HTMLFormElement;

    if (form) {
      // Small delay to ensure intl-tel-input is initialized
      setTimeout(() => {
        initFormValidation(form, async (formData) => {
          const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
          const originalText = submitBtn.textContent;

          try {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Отправка...';

            const response = await fetch(`${API_URL}/api/apply`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                name: formData.name,
                phone: formData.phone,
              }),
            });

            if (!response.ok) {
              throw new Error('Failed to submit');
            }

            alert('Заявка отправлена! Мы свяжемся с вами в ближайшее время.');
            form.reset();
          } catch (error) {
            console.error('Form submission error:', error);
            alert('Произошла ошибка при отправке. Пожалуйста, попробуйте позже.');
          } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        });
      }, 100);
    }
  });
</script>
